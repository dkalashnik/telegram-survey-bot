# Architecture Improvement Plan

| # | Change | Description | State |
| --- | --- | --- | --- |
| 1a | Establish shared `botport` package | Create `pkg/ports/botport` with `BotPort`, `BotMessage`, and `BotError`, update strategy contexts/tests to reference it, keeping existing Telegram client wiring intact (see `PRPs/PRP-001a_bot-interface`). Next: once the FSM wires adapter results, populate the new `LastPrompt`/`Message` fields so strategies can consume `botport.BotMessage` without another refactor. | Completed |
| 1b | Extract Telegram BotPort adapter | Wrap `pkg/bot.Client` behind a `TelegramAdapter`, add adapter factory/wiring in `main.go`, but leave FSM/state untouched for now (see `PRPs/PRP-001b_bot-interface`). Ensure the adapter returns fully-populated `botport.BotMessage` values so the next slice can hydrate `LastPrompt`/`Message` in strategy contexts. | Completed |
| 1c | Rewire FSM/state + add fake adapter | Introduce a fake BotPort for tests, refactor `pkg/fsm` + `pkg/state` to depend on the port exclusively, hydrate `RenderContext.LastPrompt` and `AnswerContext.Message` from adapter responses, and add headless FSM tests that run via the fake (see `PRPs/PRP-001c_bot-interface`). | Completed |
| 1d | Docs & validation polish | Update docs/README to describe BotPort + adapters, document env toggles, and add validation checks so `pkg/fsm`/`pkg/state` stay port-only (see `PRPs/PRP-001d_bot-interface`). | Completed |
| 2 | Add question-type strategy registry | Move question rendering/answer handling into discrete strategies keyed by `QuestionConfig.Type`, so `pkg/fsm` orchestrates flows without editing switch statements for every new type, keeping the module open for extension but closed for modification. (Implemented via PRP-002: see `pkg/fsm/questions`, README, docs/* updates.) | Completed |
| 3 | Provide injectable config service | Replace the global singleton (`config.GetConfig`) with a provider interface injected into consumers, allowing explicit lifecycle control, easier testing, and future runtime reloads while reducing implicit coupling. | Proposed |
| 4 | Add integration test harness | Stand up an integration test suite (either lightweight mocks or Dockerized Telegram emulator) that drives `/start`, section selection, and question flows end-to-end to detect regressions in FSM + strategy interactions before deployment. | Proposed |
| 5 | Internationalize prompts | Extract all hard-coded Telegram messages/prompts into a dedicated localization layer (e.g., YAML/JSON or Go map) so future translations can swap labels per locale and strategies render via variables instead of baked-in strings. | Proposed |
| 6 | Forward answered sections from main menu | Add a main-menu action to compile all answered sections into a single message, forward it to a specified user ID, and clear stored answers after forwarding. Now includes target-ID confirmation/logging and a startup ping to TARGET_USER_ID to verify delivery wiring. | Completed |
